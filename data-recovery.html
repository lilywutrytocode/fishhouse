<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æ¢å¤å·¥å…·</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,sans-serif;background:#0a0a0f;color:#f5f5f7;min-height:100vh;padding:20px}
        h1{font-size:24px;margin-bottom:20px;text-align:center}
        .card{background:#1a1a24;border-radius:12px;padding:20px;margin-bottom:16px}
        .card-title{font-size:16px;font-weight:600;margin-bottom:12px;color:#a5b4fc}
        .key-item{background:#12121a;padding:12px;border-radius:8px;margin-bottom:8px;word-break:break-all}
        .key-name{font-weight:600;color:#22c55e;margin-bottom:4px}
        .key-preview{font-size:12px;color:#8e8e93;max-height:60px;overflow:hidden}
        .btn{width:100%;padding:16px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:12px}
        .btn-primary{background:#6366f1;color:white}
        .btn-success{background:#22c55e;color:white}
        .btn-danger{background:#ef4444;color:white}
        .status{padding:16px;border-radius:10px;margin-top:16px;text-align:center}
        .status-success{background:#22c55e22;color:#22c55e}
        .status-error{background:#ef444422;color:#ef4444}
        .status-info{background:#6366f122;color:#a5b4fc}
        .empty{text-align:center;color:#5e5e63;padding:40px}
        #log{background:#12121a;padding:12px;border-radius:8px;font-size:12px;color:#8e8e93;max-height:200px;overflow-y:auto;white-space:pre-wrap;margin-top:12px}
    </style>
</head>
<body>
    <h1>ğŸ”§ æ•°æ®æ¢å¤å·¥å…·</h1>
    
    <div class="card">
        <div class="card-title">ğŸ“‹ æ£€æµ‹åˆ°çš„ localStorage æ•°æ®</div>
        <div id="keysList"></div>
    </div>
    
    <div class="card">
        <div class="card-title">ğŸš€ æ“ä½œ</div>
        <button class="btn btn-primary" onclick="autoMigrate()">è‡ªåŠ¨è¿ç§»åˆ° v7</button>
        <button class="btn btn-success" onclick="refreshKeys()">åˆ·æ–°æ£€æµ‹</button>
        <div id="status"></div>
        <div id="log"></div>
    </div>
    
    <div class="card">
        <div class="card-title">âš ï¸ å±é™©æ“ä½œ</div>
        <button class="btn btn-danger" onclick="clearOldData()">æ¸…é™¤æ‰€æœ‰æ—§ç‰ˆæœ¬æ•°æ®</button>
    </div>

    <script>
        const V7_KEY = 'portfolio_v7';
        const SETTINGS_V7_KEY = 'settings_v7';
        
        // å¯èƒ½çš„æ—§æ•°æ® key
        const OLD_DATA_KEYS = [
            'portfolio_v6', 'portfolio_v5', 'portfolio_v4', 
            'portfolio_data_v3', 'portfolio_data_v2', 'portfolio_data',
            'portfolioData', 'assets', 'portfolio'
        ];
        const OLD_SETTINGS_KEYS = [
            'settings_v6', 'settings_v5', 'settings_v4',
            'portfolio_settings_v3', 'portfolio_settings_v2', 'portfolio_settings',
            'settings', 'portfolioSettings'
        ];
        
        function log(msg) {
            const logEl = document.getElementById('log');
            logEl.textContent += new Date().toLocaleTimeString() + ' - ' + msg + '\n';
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function showStatus(msg, type) {
            document.getElementById('status').innerHTML = '<div class="status status-' + type + '">' + msg + '</div>';
        }
        
        function refreshKeys() {
            const container = document.getElementById('keysList');
            const allKeys = Object.keys(localStorage);
            
            if (allKeys.length === 0) {
                container.innerHTML = '<div class="empty">æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ•°æ®</div>';
                return;
            }
            
            let html = '';
            allKeys.forEach(key => {
                const value = localStorage.getItem(key);
                const preview = value.length > 100 ? value.substring(0, 100) + '...' : value;
                const isV7 = key === V7_KEY || key === SETTINGS_V7_KEY;
                const isOldData = OLD_DATA_KEYS.includes(key) || OLD_SETTINGS_KEYS.includes(key);
                
                let badge = '';
                if (isV7) badge = ' âœ… å½“å‰ç‰ˆæœ¬';
                else if (isOldData) badge = ' ğŸ“¦ å¯è¿ç§»';
                
                html += '<div class="key-item">';
                html += '<div class="key-name">' + key + badge + '</div>';
                html += '<div class="key-preview">' + preview + '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
            log('æ£€æµ‹åˆ° ' + allKeys.length + ' ä¸ª key: ' + allKeys.join(', '));
        }
        
        function autoMigrate() {
            log('å¼€å§‹è‡ªåŠ¨è¿ç§»...');
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ v7 æ•°æ®
            const existingV7 = localStorage.getItem(V7_KEY);
            if (existingV7) {
                const data = JSON.parse(existingV7);
                if (data && data.length > 0) {
                    if (!confirm('å·²å­˜åœ¨ v7 æ•°æ®ï¼ˆ' + data.length + ' æ¡è®°å½•ï¼‰ï¼Œç¡®å®šè¦è¦†ç›–å—ï¼Ÿ')) {
                        log('ç”¨æˆ·å–æ¶ˆè¿ç§»');
                        return;
                    }
                }
            }
            
            // æŸ¥æ‰¾æ—§æ•°æ®
            let foundDataKey = null;
            let foundData = null;
            
            for (const key of OLD_DATA_KEYS) {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            foundDataKey = key;
                            foundData = data;
                            log('æ‰¾åˆ°æ•°æ®: ' + key + ' (' + parsed.length + ' æ¡è®°å½•)');
                            break;
                        }
                    } catch (e) {
                        log('è§£æå¤±è´¥: ' + key);
                    }
                }
            }
            
            // æŸ¥æ‰¾æ—§è®¾ç½®
            let foundSettingsKey = null;
            let foundSettings = null;
            
            for (const key of OLD_SETTINGS_KEYS) {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        JSON.parse(data);
                        foundSettingsKey = key;
                        foundSettings = data;
                        log('æ‰¾åˆ°è®¾ç½®: ' + key);
                        break;
                    } catch (e) {}
                }
            }
            
            // æ‰§è¡Œè¿ç§»
            if (foundData) {
                localStorage.setItem(V7_KEY, foundData);
                log('âœ… æ•°æ®å·²è¿ç§»åˆ° ' + V7_KEY);
            }
            
            if (foundSettings) {
                localStorage.setItem(SETTINGS_V7_KEY, foundSettings);
                log('âœ… è®¾ç½®å·²è¿ç§»åˆ° ' + SETTINGS_V7_KEY);
            }
            
            if (foundData || foundSettings) {
                showStatus('âœ… è¿ç§»æˆåŠŸï¼è¯·è¿”å›ä¸»é¡µé¢åˆ·æ–°', 'success');
                refreshKeys();
            } else {
                showStatus('âŒ æœªæ‰¾åˆ°å¯è¿ç§»çš„æ—§æ•°æ®', 'error');
                log('æœªæ‰¾åˆ°æ—§æ•°æ®ï¼Œå½“å‰æ‰€æœ‰ key: ' + Object.keys(localStorage).join(', '));
            }
        }
        
        function clearOldData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ—§ç‰ˆæœ¬æ•°æ®å—ï¼Ÿï¼ˆv7 æ•°æ®ä¼šä¿ç•™ï¼‰')) return;
            
            let cleared = 0;
            [...OLD_DATA_KEYS, ...OLD_SETTINGS_KEYS].forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    cleared++;
                    log('å·²åˆ é™¤: ' + key);
                }
            });
            
            showStatus('å·²æ¸…é™¤ ' + cleared + ' ä¸ªæ—§æ•°æ®', 'info');
            refreshKeys();
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
        refreshKeys();
        log('å·¥å…·å·²åŠ è½½ï¼Œå½“å‰åŸŸå: ' + location.hostname);
    </script>
</body>
</html>
