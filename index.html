<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pouchy">
    <link rel="apple-touch-icon" id="appIcon">
    <title>Pouchy</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // åŠ¨æ€ç”Ÿæˆapple-touch-icon
        (function(){
            const canvas=document.createElement('canvas');
            canvas.width=180;canvas.height=180;
            const ctx=canvas.getContext('2d');
            // æ¸å˜èƒŒæ™¯
            const grad=ctx.createLinearGradient(0,0,180,180);
            grad.addColorStop(0,'#818cf8');
            grad.addColorStop(1,'#6366f1');
            ctx.fillStyle=grad;
            // åœ†è§’çŸ©å½¢
            ctx.beginPath();
            ctx.roundRect(0,0,180,180,40);
            ctx.fill();
            // ç™½è‰²å­—æ¯P
            ctx.fillStyle='rgba(255,255,255,0.95)';
            ctx.font='bold 110px -apple-system, sans-serif';
            ctx.textAlign='center';
            ctx.textBaseline='middle';
            ctx.fillText('P',90,95);
            // è®¾ç½®å›¾æ ‡
            document.getElementById('appIcon').href=canvas.toDataURL('image/png');
        })();
    </script>
    <style>
        :root{--bg-primary:#0a0a0f;--bg-secondary:#12121a;--bg-card:#1a1a24;--bg-hover:#22222e;--text-primary:#f5f5f7;--text-secondary:#8e8e93;--text-muted:#5e5e63;--border:#2a2a35;--accent:#6366f1;--accent-glow:rgba(99,102,241,0.3);--radius:16px;--radius-sm:10px}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:'DM Sans','Noto Sans SC',-apple-system,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;padding:0 0 100px 0;overflow-x:hidden}
        .header{position:sticky;top:0;z-index:100;background:linear-gradient(to bottom,var(--bg-primary) 60%,transparent);padding:20px 20px 30px}
        .header-row{display:flex;justify-content:space-between;align-items:center}
        .header h1{font-size:28px;font-weight:700;background:linear-gradient(135deg,#fff 0%,#a5b4fc 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .header-subtitle{color:var(--text-secondary);font-size:14px;margin-top:4px}
        .privacy-switch{display:flex;align-items:center;gap:8px;cursor:pointer}
        .privacy-switch-label{font-size:12px;color:var(--text-secondary)}
        .switch-track{width:50px;height:28px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:14px;position:relative;transition:all 0.3s}
        .switch-thumb{position:absolute;top:3px;left:3px;width:20px;height:20px;background:var(--text-secondary);border-radius:50%;transition:all 0.3s;display:flex;align-items:center;justify-content:center;font-size:12px}
        .privacy-switch.active .switch-track{background:var(--accent);border-color:var(--accent)}
        .privacy-switch.active .switch-thumb{left:25px;background:white}
        .total-section{padding:0 20px 24px}
        .total-card{background:linear-gradient(145deg,#1e1e2a 0%,#16161f 100%);border:1px solid var(--border);border-radius:var(--radius);padding:24px;position:relative;overflow:hidden}
        .total-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent)}
        .total-label{font-size:13px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
        .total-value{font-size:36px;font-weight:700;letter-spacing:-1px}
        .currency-toggle{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
        .currency-btn{padding:8px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s}
        .currency-btn.active{background:var(--accent);border-color:var(--accent);color:white}
        .chart-section{padding:0 20px 24px}
        .chart-container{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px}
        .chart-tabs{display:flex;gap:8px;margin-bottom:20px;justify-content:center}
        .chart-tab{padding:10px 20px;border-radius:25px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-size:14px;cursor:pointer;transition:all 0.2s}
        .chart-tab.active{background:var(--accent);border-color:var(--accent);color:white}
        .chart-view{display:none}.chart-view.active{display:block}
        .single-chart{display:flex;flex-direction:column;gap:12px}
        .chart-main{display:flex;align-items:center;gap:16px}
        .pie-chart-wrapper{position:relative;width:140px;height:140px;flex-shrink:0}
        .pie-chart{width:100%;height:100%;transform:rotate(-90deg)}
        .pie-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none}
        .pie-center-label{font-size:9px;color:var(--text-secondary)}
        .pie-center-value{font-size:16px;font-weight:700;margin-top:2px}
        .legend-main{flex:1;display:flex;flex-direction:column;gap:6px}
        .legend-item{display:flex;align-items:center;gap:8px;padding:10px;background:var(--bg-secondary);border-radius:8px}
        .legend-dot{width:8px;height:8px;border-radius:3px;flex-shrink:0}
        .legend-info{flex:1;min-width:0;overflow:hidden}
        .legend-name{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .legend-amount{font-size:10px;color:var(--text-secondary);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .legend-percent{font-size:12px;font-weight:600;color:var(--text-secondary);flex-shrink:0;margin-left:4px}
        .legend-bottom{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
        .legend-bottom .legend-item{padding:10px}
        .ratio-view{padding:10px 0}
        .ratio-header{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:20px}
        .ratio-icon{font-size:36px}
        .ratio-status{text-align:center}
        .ratio-status-text{font-size:14px;font-weight:600}
        .ratio-status-sub{font-size:11px;color:var(--text-secondary);margin-top:2px}
        .ratio-bar-container{margin-bottom:16px}
        .ratio-bar-labels{display:flex;justify-content:space-between;margin-bottom:8px;font-size:12px}
        .ratio-bar-label{display:flex;align-items:center;gap:6px}
        .ratio-bar-dot{width:10px;height:10px;border-radius:3px}
        .ratio-bar-name{color:var(--text-secondary)}
        .ratio-bar-value{font-weight:600}
        .ratio-bar-track{height:32px;background:var(--bg-secondary);border-radius:16px;overflow:hidden;display:flex}
        .ratio-bar-segment{height:100%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:white;transition:width 0.5s ease}
        .ratio-bar-saving{background:linear-gradient(90deg,#3B82F6,#10B981)}
        .ratio-bar-invest{background:linear-gradient(90deg,#F97316,#EAB308)}
        .ratio-details{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .ratio-detail-card{background:var(--bg-secondary);border-radius:var(--radius-sm);padding:14px}
        .ratio-detail-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
        .ratio-detail-icon{font-size:18px}
        .ratio-detail-title{font-size:13px;font-weight:600}
        .ratio-detail-amount{font-size:16px;font-weight:700;margin-bottom:4px}
        .ratio-detail-percent{font-size:11px;color:var(--text-secondary)}
        .ratio-detail-items{margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
        .ratio-detail-item{display:flex;justify-content:space-between;font-size:11px;color:var(--text-secondary);margin-bottom:4px}
        .pie-label{position:absolute;font-size:10px;color:var(--text-primary);white-space:nowrap}
        .pie-label-line{position:absolute;pointer-events:none}
        .legend{width:100%;display:flex;flex-direction:column;gap:8px}
        .legend-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-secondary);border-radius:var(--radius-sm)}
        .legend-dot{width:12px;height:12px;border-radius:4px;flex-shrink:0}
        .legend-info{flex:1;min-width:0}
        .legend-name{font-size:14px;font-weight:500}
        .legend-amount{font-size:12px;color:var(--text-secondary);margin-top:2px}
        .legend-percent{font-size:14px;font-weight:600}
        .multi-chart-grid{display:flex;flex-direction:column;gap:24px}
        .mini-chart-card{background:var(--bg-secondary);border-radius:var(--radius-sm);padding:16px}
        .mini-chart-title{font-size:15px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px}
        .mini-chart-title-dot{width:8px;height:8px;border-radius:50%}
        .mini-chart-content{display:flex;gap:16px;align-items:center}
        .mini-pie-wrapper{position:relative;width:100px;height:100px;flex-shrink:0}
        .mini-pie-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;font-size:11px;font-weight:600}
        .mini-legend{flex:1;display:flex;flex-direction:column;gap:6px}
        .mini-legend-item{display:flex;align-items:center;gap:8px;font-size:13px}
        .mini-legend-dot{width:8px;height:8px;border-radius:3px;flex-shrink:0}
        .mini-legend-name{flex:1}.mini-legend-percent{color:var(--text-secondary)}
        .rate-banner{padding:10px 20px;background:var(--bg-secondary);border-bottom:1px solid var(--border);display:flex;justify-content:center;gap:12px;font-size:11px;color:var(--text-secondary);flex-wrap:wrap}
        .rate-item{display:flex;align-items:center;gap:4px}
        .rate-value{color:var(--text-primary);font-weight:500}
        .assets-section{padding:0 20px}
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .section-title{font-size:18px;font-weight:600}
        .add-btn{width:36px;height:36px;border-radius:50%;border:none;background:var(--accent);color:white;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px var(--accent-glow)}
        .category-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:12px;overflow:hidden}
        .category-header{display:flex;align-items:center;padding:16px;cursor:pointer;transition:background 0.2s}
        .category-header:hover{background:var(--bg-hover)}
        .category-color{width:4px;height:40px;border-radius:2px;margin-right:14px}
        .category-info{flex:1}
        .category-name{font-size:15px;font-weight:600;margin-bottom:2px}
        .category-count{font-size:12px;color:var(--text-secondary)}
        .category-value{text-align:right}
        .category-amount{font-size:16px;font-weight:600}
        .category-percent{font-size:12px;color:var(--text-secondary)}
        .category-chevron{margin-left:12px;color:var(--text-muted);transition:transform 0.3s}
        .category-card.expanded .category-chevron{transform:rotate(180deg)}
        .sub-category{border-top:1px solid var(--border);display:none}
        .category-card.expanded .sub-category{display:block}
        .sub-category-header{display:flex;align-items:center;padding:12px 16px 12px 34px;background:var(--bg-secondary);cursor:pointer}
        .sub-category-header:hover{background:var(--bg-hover)}
        .sub-category-dot{width:8px;height:8px;border-radius:50%;margin-right:10px}
        .sub-category-name{flex:1;font-size:14px;font-weight:500}
        .sub-category-value{font-size:14px;font-weight:500}
        .sub-category-chevron{margin-left:10px;font-size:12px;color:var(--text-muted);transition:transform 0.3s}
        .sub-category.expanded .sub-category-chevron{transform:rotate(180deg)}
        .sub-items{display:none;background:var(--bg-primary)}
        .sub-category.expanded .sub-items{display:block}
        .sub-item{display:flex;align-items:center;padding:14px 16px 14px 52px;border-bottom:1px solid var(--border)}
        .sub-item:last-child{border-bottom:none}
        .sub-item-info{flex:1}
        .sub-item-name{font-size:14px;font-weight:500}
        .sub-item-detail{font-size:12px;color:var(--text-secondary);margin-top:2px}
        .sub-item-value{font-size:15px;font-weight:600}
        .sub-item-actions{display:flex;gap:8px;margin-left:12px}
        .action-btn{width:32px;height:32px;border-radius:8px;border:none;background:var(--bg-secondary);color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center}
        .action-btn:hover{background:var(--accent);color:white}
        .action-btn.delete:hover{background:#ef4444}
        .add-sub-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;color:var(--accent);font-size:13px;font-weight:500;cursor:pointer;border-top:1px solid var(--border)}
        .add-sub-btn:hover{background:var(--bg-hover)}
        .settings-btn{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);font-size:24px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:50}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:1000;display:none;align-items:flex-end;justify-content:center}
        .modal-overlay.active{display:flex}
        .modal{width:100%;max-width:500px;max-height:90vh;background:var(--bg-card);border-radius:var(--radius) var(--radius) 0 0;padding:24px 20px 40px;overflow-y:auto;animation:slideUp 0.3s ease}
        @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
        .modal-title{font-size:20px;font-weight:600}
        .modal-close{width:36px;height:36px;border-radius:50%;border:none;background:var(--bg-secondary);color:var(--text-secondary);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .form-group{margin-bottom:20px}
        .form-label{display:block;font-size:13px;color:var(--text-secondary);margin-bottom:8px}
        .form-input,.form-select{width:100%;padding:14px 16px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:16px;font-family:inherit;outline:none}
        .form-input:focus,.form-select:focus{border-color:var(--accent)}
        .form-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%238e8e93' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .submit-btn{width:100%;padding:16px;border:none;border-radius:var(--radius-sm);background:var(--accent);color:white;font-size:16px;font-weight:600;cursor:pointer}
        .submit-btn:hover{background:#5558e3}
        .danger-btn{background:#ef4444;margin-top:12px}
        .danger-btn:hover{background:#dc2626}
        .empty-state{text-align:center;padding:60px 20px;color:var(--text-secondary)}
        .empty-icon{font-size:48px;margin-bottom:16px;opacity:0.5}
        .hidden{display:none!important}
        .no-data-msg{text-align:center;padding:20px;color:var(--text-muted);font-size:13px}
        .data-section{margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid var(--border)}
        .data-section-title{font-size:14px;font-weight:600;margin-bottom:12px;color:var(--text-primary)}
        .data-actions{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .data-btn{padding:14px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-secondary);color:var(--text-primary);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s}
        .data-btn:hover{border-color:var(--accent);background:var(--bg-hover)}
    </style>
</head>
<body>
    <div class="rate-banner">
        <div class="rate-item">USD <span class="rate-value" id="rateUsdCny">7.25</span></div>
        <div class="rate-item">HKD <span class="rate-value" id="rateHkdCny">0.93</span></div>
        <div class="rate-item">JPY <span class="rate-value" id="rateJpyCny">0.046</span></div>
        <div class="rate-item">é‡‘ <span class="rate-value" id="rateGold">685</span>/å…‹</div>
    </div>
    <header class="header">
        <div class="header-row">
            <div>
                <h1>èµ„äº§é…ç½®</h1>
                <p class="header-subtitle">Portfolio Overview</p>
            </div>
            <div class="privacy-switch" id="privacySwitch" onclick="togglePrivacy()">
                <span class="privacy-switch-label">éšç§</span>
                <div class="switch-track">
                    <div class="switch-thumb">ğŸ”“</div>
                </div>
            </div>
        </div>
    </header>
    <section class="total-section">
        <div class="total-card">
            <div class="total-label">æ€»èµ„äº§</div>
            <div class="total-value" id="totalValue">Â¥0.00</div>
            <div class="currency-toggle">
                <button class="currency-btn active" data-currency="CNY">äººæ°‘å¸</button>
                <button class="currency-btn" data-currency="USD">ç¾å…ƒ</button>
                <button class="currency-btn" data-currency="HKD">æ¸¯å¸</button>
                <button class="currency-btn" data-currency="JPY">æ—¥å…ƒ</button>
            </div>
        </div>
    </section>
    <section class="chart-section">
        <div class="chart-container">
            <div class="chart-tabs">
                <button class="chart-tab active" data-level="overview">å…¨æ™¯è§†å›¾</button>
                <button class="chart-tab" data-level="breakdown">åˆ†ç±»è¯¦æƒ…</button>
                <button class="chart-tab" data-level="ratio">æŠ•å‚¨æ¯”</button>
            </div>
            <div class="chart-view active" id="overviewChart">
                <div class="single-chart">
                    <div class="chart-main">
                        <div class="pie-chart-wrapper">
                            <svg class="pie-chart" viewBox="0 0 100 100" id="mainPieChart"></svg>
                            <div class="pie-center"><div class="pie-center-label">æ€»èµ„äº§</div><div class="pie-center-value" id="mainPieValue">0</div></div>
                        </div>
                        <div class="legend-main" id="mainLegend"></div>
                    </div>
                    <div class="legend-bottom" id="bottomLegend"></div>
                </div>
            </div>
            <div class="chart-view" id="ratioChart">
                <div class="ratio-view">
                    <div class="ratio-header">
                        <div class="ratio-icon" id="ratioIcon">ğŸ›¡ï¸</div>
                        <div class="ratio-status">
                            <div class="ratio-status-text" id="ratioStatusText">è´¢åŠ¡çŠ¶å†µå¥åº·</div>
                            <div class="ratio-status-sub" id="ratioStatusSub">å‚¨è“„å……è¶³ï¼Œé£é™©å¯æ§</div>
                        </div>
                    </div>
                    <div class="ratio-bar-container">
                        <div class="ratio-bar-labels">
                            <div class="ratio-bar-label"><div class="ratio-bar-dot" style="background:linear-gradient(90deg,#3B82F6,#10B981)"></div><span class="ratio-bar-name">å‚¨è“„</span><span class="ratio-bar-value" id="ratioSavingPct">0%</span></div>
                            <div class="ratio-bar-label"><span class="ratio-bar-value" id="ratioInvestPct">0%</span><span class="ratio-bar-name">æŠ•èµ„</span><div class="ratio-bar-dot" style="background:linear-gradient(90deg,#F97316,#EAB308)"></div></div>
                        </div>
                        <div class="ratio-bar-track">
                            <div class="ratio-bar-segment ratio-bar-saving" id="ratioBarSaving" style="width:50%"></div>
                            <div class="ratio-bar-segment ratio-bar-invest" id="ratioBarInvest" style="width:50%"></div>
                        </div>
                    </div>
                    <div class="ratio-details">
                        <div class="ratio-detail-card">
                            <div class="ratio-detail-header"><span class="ratio-detail-icon">ğŸ¦</span><span class="ratio-detail-title">å‚¨è“„</span></div>
                            <div class="ratio-detail-amount" id="ratioSavingAmount">Â¥0</div>
                            <div class="ratio-detail-percent" id="ratioSavingDesc">å®šæœŸ + æ´»æœŸå­˜æ¬¾</div>
                            <div class="ratio-detail-items" id="ratioSavingItems"></div>
                        </div>
                        <div class="ratio-detail-card">
                            <div class="ratio-detail-header"><span class="ratio-detail-icon">ğŸ“ˆ</span><span class="ratio-detail-title">æŠ•èµ„</span></div>
                            <div class="ratio-detail-amount" id="ratioInvestAmount">Â¥0</div>
                            <div class="ratio-detail-percent" id="ratioInvestDesc">è‚¡ç¥¨ã€åŸºé‡‘ã€é»„é‡‘ç­‰</div>
                            <div class="ratio-detail-items" id="ratioInvestItems"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chart-view" id="breakdownChart"><div class="multi-chart-grid" id="multiChartGrid"></div></div>
        </div>
    </section>
    <section class="assets-section">
        <div class="section-header"><h2 class="section-title">èµ„äº§æ˜ç»†</h2><button class="add-btn" onclick="openAddModal()">+</button></div>
        <div id="assetsList"></div>
    </section>
    <button class="settings-btn" onclick="openSettingsModal()">âš™</button>

    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">æ·»åŠ èµ„äº§</h3><button class="modal-close" onclick="closeAddModal()">Ã—</button></div>
            <form id="addForm" onsubmit="handleAddAsset(event)">
                <div class="form-group"><label class="form-label">èµ„äº§ç±»åˆ«</label>
                    <select class="form-select" id="assetLevel1" onchange="updateLevel2Options()">
                        <option value="fixed_deposit">å®šæœŸå­˜æ¬¾</option>
                        <option value="demand_deposit">æ´»æœŸå­˜æ¬¾</option>
                        <option value="stock">è‚¡ç¥¨</option>
                        <option value="fund">åŸºé‡‘</option>
                        <option value="gold">çº¸é»„é‡‘</option>
                        <option value="futures">æœŸè´§</option>
                        <option value="housing_fund">ä½æˆ¿å…¬ç§¯é‡‘</option>
                    </select>
                </div>
                <div class="form-group" id="level2Group"><label class="form-label">å­ç±»åˆ«</label><select class="form-select" id="assetLevel2" onchange="updateFormFields()"></select></div>
                <div class="form-group" id="bankGroup"><label class="form-label">é“¶è¡Œ</label>
                    <select class="form-select" id="assetBank">
                        <option value="ä¸­å›½é“¶è¡Œ">ä¸­å›½é“¶è¡Œ</option><option value="å»ºè®¾é“¶è¡Œ">å»ºè®¾é“¶è¡Œ</option><option value="å†œä¸šé“¶è¡Œ">å†œä¸šé“¶è¡Œ</option>
                        <option value="æ‹›å•†é“¶è¡Œ">æ‹›å•†é“¶è¡Œ</option><option value="å·¥å•†é“¶è¡Œ">å·¥å•†é“¶è¡Œ</option><option value="æ±‡ä¸°é“¶è¡Œ">æ±‡ä¸°é“¶è¡Œ</option>
                        <option value="ä¸­é“¶é¦™æ¸¯">ä¸­é“¶é¦™æ¸¯</option><option value="ç¾å›½é“¶è¡Œ">ç¾å›½é“¶è¡Œ</option>
                    </select>
                </div>
                <div class="form-group" id="nameGroup"><label class="form-label" id="nameLabel">åç§°</label><input type="text" class="form-input" id="assetName" placeholder="ä¾‹: è´µå·èŒ…å°"></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label" id="amountLabel">é‡‘é¢</label><input type="number" class="form-input" id="assetAmount" placeholder="0.00" step="0.01" required></div>
                    <div class="form-group" id="currencyGroup"><label class="form-label">å¸ç§</label>
                        <select class="form-select" id="assetCurrency"><option value="CNY">äººæ°‘å¸ Â¥</option><option value="USD">ç¾å…ƒ $</option><option value="HKD">æ¸¯å¸ HK$</option><option value="JPY">æ—¥å…ƒ Â¥</option></select>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">å¤‡æ³¨ (å¯é€‰)</label><input type="text" class="form-input" id="assetNote" placeholder="ä¾‹: 3å¹´æœŸ"></div>
                <button type="submit" class="submit-btn">æ·»åŠ èµ„äº§</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">è®¾ç½®</h3><button class="modal-close" onclick="closeSettingsModal()">Ã—</button></div>
            
            <div class="data-section">
                <div class="data-section-title">ğŸ“¦ æ•°æ®ç®¡ç†</div>
                <div class="data-actions">
                    <button class="data-btn" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                    <button class="data-btn" onclick="document.getElementById('importFile').click()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                </div>
            </div>
            
            <form id="settingsForm" onsubmit="handleSaveSettings(event)">
                <div class="data-section-title">ğŸ’± æ±‡ç‡è®¾ç½®</div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">USD/CNY</label><input type="number" class="form-input" id="settingUsdCny" step="0.0001"></div>
                    <div class="form-group"><label class="form-label">HKD/CNY</label><input type="number" class="form-input" id="settingHkdCny" step="0.0001"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">JPY/CNY</label><input type="number" class="form-input" id="settingJpyCny" step="0.0001"></div>
                    <div class="form-group"><label class="form-label">é»„é‡‘(å…ƒ/å…‹)</label><input type="number" class="form-input" id="settingGold" step="0.01"></div>
                </div>
                <button type="submit" class="submit-btn">ä¿å­˜è®¾ç½®</button>
                <button type="button" class="submit-btn danger-btn" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">ç¼–è¾‘èµ„äº§</h3><button class="modal-close" onclick="closeEditModal()">Ã—</button></div>
            <form id="editForm" onsubmit="handleEditAsset(event)">
                <input type="hidden" id="editAssetId">
                <div class="form-group"><label class="form-label">åç§°</label><input type="text" class="form-input" id="editAssetName" required></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label" id="editAmountLabel">é‡‘é¢</label><input type="number" class="form-input" id="editAssetAmount" step="0.01" required></div>
                    <div class="form-group" id="editCurrencyGroup"><label class="form-label">å¸ç§</label>
                        <select class="form-select" id="editAssetCurrency"><option value="CNY">äººæ°‘å¸ Â¥</option><option value="USD">ç¾å…ƒ $</option><option value="HKD">æ¸¯å¸ HK$</option><option value="JPY">æ—¥å…ƒ Â¥</option></select>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">å¤‡æ³¨</label><input type="text" class="form-input" id="editAssetNote"></div>
                <button type="submit" class="submit-btn">ä¿å­˜ä¿®æ”¹</button>
            </form>
        </div>
    </div>

    <script>
        const STORAGE_KEY='portfolio_v7',SETTINGS_KEY='settings_v7';
        // 7ä¸ªä¸€çº§ç±»åˆ«é¢œè‰² - ä¼˜åŒ–é¢œè‰²åŒºåˆ†åº¦
        const categoryStructure={
            fixed_deposit:{name:'å®šæœŸå­˜æ¬¾',color:'#3B82F6',subCategories:{
                cny:{name:'äººæ°‘å¸',color:'#3B82F6',defaultCurrency:'CNY',isBank:true},
                usd:{name:'ç¾å…ƒ',color:'#10B981',defaultCurrency:'USD',isBank:true}
            }},
            demand_deposit:{name:'æ´»æœŸå­˜æ¬¾',color:'#10B981',subCategories:{
                cny:{name:'äººæ°‘å¸',color:'#10B981',defaultCurrency:'CNY',isBank:true},
                usd:{name:'ç¾å…ƒ',color:'#3B82F6',defaultCurrency:'USD',isBank:true},
                hkd:{name:'æ¸¯å¸',color:'#F97316',defaultCurrency:'HKD',isBank:true},
                jpy:{name:'æ—¥å…ƒ',color:'#A855F7',defaultCurrency:'JPY',isBank:true}
            }},
            stock:{name:'è‚¡ç¥¨',color:'#F97316',subCategories:{
                dongcai_a:{name:'ä¸œè´¢-Aè‚¡',color:'#F97316',defaultCurrency:'CNY',isBank:false},
                zhongjian_a:{name:'ä¸­å»º-Aè‚¡',color:'#E69F00',defaultCurrency:'CNY',isBank:false},
                dongzheng_a:{name:'ä¸œè¯-Aè‚¡',color:'#F0E442',defaultCurrency:'CNY',isBank:false},
                hsbc_hk:{name:'æ¸¯è‚¡-æ±‡ä¸°',color:'#009E73',defaultCurrency:'HKD',isBank:false},
                boc_us:{name:'ç¾è‚¡-ä¸­é“¶',color:'#56B4E9',defaultCurrency:'USD',isBank:false}
            }},
            fund:{name:'åŸºé‡‘',color:'#8B5CF6',subCategories:null},
            gold:{name:'çº¸é»„é‡‘',color:'#EAB308',subCategories:null,isGold:true},
            futures:{name:'æœŸè´§',color:'#EC4899',subCategories:null},
            housing_fund:{name:'ä½æˆ¿å…¬ç§¯é‡‘',color:'#94A3B8',subCategories:null}
        };
        const breakdownCategories=['fixed_deposit','demand_deposit','stock'];
        let portfolioData=[],settings={usdCny:7.25,hkdCny:0.93,jpyCny:0.046,goldPrice:685},currentDisplayCurrency='CNY',currentChartView='overview';
        let privacyMode=false;

        function migrateOldData(){
            if(localStorage.getItem(STORAGE_KEY))return;
            const oldKeys=['portfolio_v6','portfolio_v5','portfolio_v4','portfolio_data_v3','portfolio_data_v2','portfolio_data'];
            for(const key of oldKeys){const old=localStorage.getItem(key);if(old){localStorage.setItem(STORAGE_KEY,old);console.log('å·²ä» '+key+' è¿ç§»æ•°æ®');break;}}
            const oldSettingsKeys=['settings_v6','settings_v5','settings_v4','portfolio_settings_v3','portfolio_settings_v2','portfolio_settings'];
            for(const key of oldSettingsKeys){const old=localStorage.getItem(key);if(old){localStorage.setItem(SETTINGS_KEY,old);break;}}
        }

        function loadData(){migrateOldData();const s=localStorage.getItem(STORAGE_KEY);if(s)portfolioData=JSON.parse(s);const t=localStorage.getItem(SETTINGS_KEY);if(t)settings=JSON.parse(t);updateRateBanner()}
        function saveData(){localStorage.setItem(STORAGE_KEY,JSON.stringify(portfolioData));localStorage.setItem(SETTINGS_KEY,JSON.stringify(settings))}
        function updateRateBanner(){document.getElementById('rateUsdCny').textContent=settings.usdCny;document.getElementById('rateHkdCny').textContent=settings.hkdCny;document.getElementById('rateJpyCny').textContent=settings.jpyCny;document.getElementById('rateGold').textContent=settings.goldPrice}

        function togglePrivacy(){privacyMode=!privacyMode;const sw=document.getElementById('privacySwitch');const thumb=sw.querySelector('.switch-thumb');if(privacyMode){sw.classList.add('active');thumb.textContent='ğŸ”’'}else{sw.classList.remove('active');thumb.textContent='ğŸ”“'}render()}

        function convertToCNY(a,c,g=false){if(g)return a*settings.goldPrice;if(c==='CNY')return a;if(c==='USD')return a*settings.usdCny;if(c==='HKD')return a*settings.hkdCny;if(c==='JPY')return a*settings.jpyCny;return a}
        function convertFromCNY(a,t){if(t==='CNY')return a;if(t==='USD')return a/settings.usdCny;if(t==='HKD')return a/settings.hkdCny;if(t==='JPY')return a/settings.jpyCny;return a}
        function formatCurrency(a,c,forceShow=false){if(privacyMode&&!forceShow)return '***';const s={CNY:'Â¥',USD:'$',HKD:'HK$',JPY:'Â¥'};const d=c==='JPY'?0:2;return s[c]+a.toLocaleString('zh-CN',{minimumFractionDigits:d,maximumFractionDigits:d})}

        function calculateTotalByCNY(){return portfolioData.reduce((s,a)=>s+convertToCNY(a.amount,a.currency,a.level1==='gold'),0)}
        function getLevel1Totals(){const t={};Object.keys(categoryStructure).forEach(k=>t[k]=0);portfolioData.forEach(a=>{t[a.level1]+=convertToCNY(a.amount,a.currency,a.level1==='gold')});return t}
        function getLevel2TotalsForCategory(l1){const c=categoryStructure[l1];if(!c.subCategories)return null;const t={};Object.keys(c.subCategories).forEach(k=>t[k]=0);portfolioData.filter(a=>a.level1===l1).forEach(a=>{if(a.level2)t[a.level2]+=convertToCNY(a.amount,a.currency,false)});return t}

        function generatePieSlices(data,r=40,w=20){const circ=2*Math.PI*r;let slices='',offset=0;const total=data.reduce((s,d)=>s+d.value,0);if(total===0)return '<circle cx="50" cy="50" r="'+r+'" fill="none" stroke="#2a2a35" stroke-width="'+w+'"/>';data.forEach(item=>{const pct=item.value/total;const len=pct*circ;slices+='<circle cx="50" cy="50" r="'+r+'" fill="none" stroke="'+item.color+'" stroke-width="'+w+'" stroke-dasharray="'+len+' '+circ+'" stroke-dashoffset="'+-offset+'" style="transition:all 0.5s"/>';offset+=len});return slices}

        function render(){renderTotal();renderOverviewChart();renderRatioChart();renderBreakdownChart();renderAssetsList()}
        function renderTotal(){const t=calculateTotalByCNY();document.getElementById('totalValue').textContent=formatCurrency(convertFromCNY(t,currentDisplayCurrency),currentDisplayCurrency)}

        function renderOverviewChart(){
            const l1t=getLevel1Totals();
            const total=calculateTotalByCNY();
            
            // è·å–æœ‰æ•°æ®çš„ç±»åˆ«
            let data=Object.entries(l1t).filter(([_,v])=>v>0).map(([k,v])=>({key:k,name:categoryStructure[k].name,color:categoryStructure[k].color,value:v,percent:total>0?(v/total*100):0}));
            
            // é¢œè‰²åŒºåˆ†åº¦æ’åºç”¨äºé¥¼å›¾æ˜¾ç¤º
            const colorOrder=['fixed_deposit','stock','fund','demand_deposit','housing_fund','gold','futures'];
            const pieData=[...data].sort((a,b)=>{
                const idxA=colorOrder.indexOf(a.key);
                const idxB=colorOrder.indexOf(b.key);
                return idxA-idxB;
            });
            
            document.getElementById('mainPieChart').innerHTML=generatePieSlices(pieData);
            
            // ä¸­å¿ƒæ˜¾ç¤ºæ€»é¢ï¼ˆæ ¹æ®å½“å‰é€‰æ‹©çš„è´§å¸ï¼Œä»¥ä¸‡ä¸ºå•ä½ï¼Œ4ä½æœ‰æ•ˆæ•°å­—ï¼‰
            const displayTotal=convertFromCNY(total,currentDisplayCurrency);
            const wan=displayTotal/10000;
            let wanStr;
            if(wan<10){
                wanStr=wan.toFixed(2); // xx.xx
            }else if(wan<100){
                wanStr=wan.toFixed(2); // xx.xx
            }else if(wan<1000){
                wanStr=wan.toFixed(1); // xxx.x
            }else{
                wanStr=Math.round(wan).toString(); // xxxx
            }
            const centerText=privacyMode?'***':wanStr+'ä¸‡';
            document.getElementById('mainPieValue').textContent=centerText;
            
            if(data.length===0){
                document.getElementById('mainLegend').innerHTML='<div class="no-data-msg">æš‚æ— æ•°æ®</div>';
                document.getElementById('bottomLegend').innerHTML='';
                return;
            }
            
            // å›¾ä¾‹æŒ‰é‡‘é¢ä»å¤§åˆ°å°æ’åº
            const legendData=[...data].sort((a,b)=>b.value-a.value);
            
            // æ ¹æ®ç±»åˆ«æ•°é‡å†³å®šå¸ƒå±€
            // â‰¤3ä¸ªï¼šå…¨éƒ¨å³ä¾§
            // 4ä¸ªï¼šå³ä¾§2ä¸ªï¼Œä¸‹æ–¹2ä¸ª
            // 5ä¸ªï¼šå³ä¾§3ä¸ªï¼Œä¸‹æ–¹2ä¸ª
            // 6ä¸ªï¼šå³ä¾§2ä¸ªï¼Œä¸‹æ–¹4ä¸ª
            // 7ä¸ªï¼šå³ä¾§3ä¸ªï¼Œä¸‹æ–¹4ä¸ª
            const totalCount=legendData.length;
            let topCount;
            if(totalCount<=3){
                topCount=totalCount;
            }else if(totalCount===4){
                topCount=2;
            }else if(totalCount===5){
                topCount=3;
            }else if(totalCount===6){
                topCount=2;
            }else{
                topCount=3;
            }
            
            const topItems=legendData.slice(0,topCount);
            const bottomItems=legendData.slice(topCount);
            
            const renderLegendItem=(item)=>'<div class="legend-item"><div class="legend-dot" style="background:'+item.color+'"></div><div class="legend-info"><div class="legend-name">'+item.name+'</div><div class="legend-amount">'+formatCurrency(convertFromCNY(item.value,currentDisplayCurrency),currentDisplayCurrency)+'</div></div><div class="legend-percent">'+item.percent.toFixed(1)+'%</div></div>';
            
            document.getElementById('mainLegend').innerHTML=topItems.map(renderLegendItem).join('');
            document.getElementById('bottomLegend').innerHTML=bottomItems.map(renderLegendItem).join('');
        }

        function renderRatioChart(){
            const l1t=getLevel1Totals();
            const total=calculateTotalByCNY();
            
            // å‚¨è“„ = å®šæœŸå­˜æ¬¾ + æ´»æœŸå­˜æ¬¾ + ä½æˆ¿å…¬ç§¯é‡‘
            const saving=(l1t.fixed_deposit||0)+(l1t.demand_deposit||0)+(l1t.housing_fund||0);
            // æŠ•èµ„ = è‚¡ç¥¨ + åŸºé‡‘ + é»„é‡‘ + æœŸè´§
            const invest=(l1t.stock||0)+(l1t.fund||0)+(l1t.gold||0)+(l1t.futures||0);
            
            const savingPct=total>0?(saving/total*100):0;
            const investPct=total>0?(invest/total*100):0;
            
            // è®¡ç®—å‚¨è“„/æŠ•èµ„æ¯”ç‡
            const ratio=invest>0?(saving/invest):999;
            
            // æ ¹æ®æ¯”ç‡è®¾ç½®çŠ¶æ€å›¾æ ‡å’Œæ–‡å­—
            // ğŸš¨ çº¢è‰²è­¦æŠ¥ï¼šå‚¨è“„ < æŠ•èµ„çš„1.2å€
            // ğŸ£ é»„è‰²å°é¸¡ï¼š1.2å€ â‰¤ å‚¨è“„ < 1.5å€
            // ğŸŒ³ ç»¿è‰²æ ‘æœ¨ï¼šå‚¨è“„ â‰¥ æŠ•èµ„çš„1.5å€
            let icon,statusText,statusSub,statusColor;
            if(ratio<1.2){
                icon='ğŸš¨';
                statusText='é£é™©è¾ƒé«˜';
                statusSub='å‚¨è“„ä¸è¶³æŠ•èµ„1.2å€ï¼Œå»ºè®®å¢åŠ å‚¨è“„';
                statusColor='#EF4444';
            }else if(ratio<1.5){
                icon='ğŸ£';
                statusText='éœ€è¦å…³æ³¨';
                statusSub='å‚¨è“„é€‚ä¸­ï¼Œå¯ç»§ç»­ç§¯ç´¯';
                statusColor='#EAB308';
            }else{
                icon='ğŸŒ³';
                statusText='è´¢åŠ¡å¥åº·';
                statusSub='å‚¨è“„å……è¶³ï¼Œé£é™©å¯æ§';
                statusColor='#10B981';
            }
            
            document.getElementById('ratioIcon').textContent=icon;
            document.getElementById('ratioStatusText').textContent=statusText;
            document.getElementById('ratioStatusText').style.color=statusColor;
            document.getElementById('ratioStatusSub').textContent=statusSub;
            
            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('ratioSavingPct').textContent=savingPct.toFixed(1)+'%';
            document.getElementById('ratioInvestPct').textContent=investPct.toFixed(1)+'%';
            document.getElementById('ratioBarSaving').style.width=savingPct+'%';
            document.getElementById('ratioBarInvest').style.width=investPct+'%';
            
            // æ›´æ–°é‡‘é¢æ˜¾ç¤º
            const savingDisp=convertFromCNY(saving,currentDisplayCurrency);
            const investDisp=convertFromCNY(invest,currentDisplayCurrency);
            document.getElementById('ratioSavingAmount').textContent=privacyMode?'***':formatCurrency(savingDisp,currentDisplayCurrency,true);
            document.getElementById('ratioInvestAmount').textContent=privacyMode?'***':formatCurrency(investDisp,currentDisplayCurrency,true);
            
            // å‚¨è“„æ˜ç»†ï¼ˆå®šæœŸã€æ´»æœŸã€å…¬ç§¯é‡‘ï¼‰
            let savingItems='';
            if(l1t.fixed_deposit>0){
                savingItems+='<div class="ratio-detail-item"><span>å®šæœŸå­˜æ¬¾</span><span>'+(privacyMode?'***':formatCurrency(convertFromCNY(l1t.fixed_deposit,currentDisplayCurrency),currentDisplayCurrency,true))+'</span></div>';
            }
            if(l1t.demand_deposit>0){
                savingItems+='<div class="ratio-detail-item"><span>æ´»æœŸå­˜æ¬¾</span><span>'+(privacyMode?'***':formatCurrency(convertFromCNY(l1t.demand_deposit,currentDisplayCurrency),currentDisplayCurrency,true))+'</span></div>';
            }
            if(l1t.housing_fund>0){
                savingItems+='<div class="ratio-detail-item"><span>ä½æˆ¿å…¬ç§¯é‡‘</span><span>'+(privacyMode?'***':formatCurrency(convertFromCNY(l1t.housing_fund,currentDisplayCurrency),currentDisplayCurrency,true))+'</span></div>';
            }
            document.getElementById('ratioSavingItems').innerHTML=savingItems||'<div class="ratio-detail-item"><span>æš‚æ— </span></div>';
            document.getElementById('ratioSavingDesc').textContent='å®šæœŸ + æ´»æœŸ + å…¬ç§¯é‡‘';
            
            // æŠ•èµ„æ˜ç»†ï¼ˆè‚¡ç¥¨ã€åŸºé‡‘ã€é»„é‡‘ã€æœŸè´§ï¼‰
            const investCategories=['stock','fund','gold','futures'];
            let investItems='';
            investCategories.forEach(cat=>{
                if(l1t[cat]>0){
                    investItems+='<div class="ratio-detail-item"><span>'+categoryStructure[cat].name+'</span><span>'+(privacyMode?'***':formatCurrency(convertFromCNY(l1t[cat],currentDisplayCurrency),currentDisplayCurrency,true))+'</span></div>';
                }
            });
            document.getElementById('ratioInvestItems').innerHTML=investItems||'<div class="ratio-detail-item"><span>æš‚æ— </span></div>';
        }

        function renderBreakdownChart(){const grid=document.getElementById('multiChartGrid');let html='';breakdownCategories.forEach(l1=>{const l1c=categoryStructure[l1];const l2t=getLevel2TotalsForCategory(l1);if(!l2t)return;const catTotal=Object.values(l2t).reduce((s,v)=>s+v,0);if(catTotal===0){html+='<div class="mini-chart-card"><div class="mini-chart-title"><div class="mini-chart-title-dot" style="background:'+l1c.color+'"></div>'+l1c.name+'</div><div class="no-data-msg">æš‚æ— æ•°æ®</div></div>';return}const data=Object.entries(l2t).filter(([_,v])=>v>0).map(([k,v])=>({key:k,name:l1c.subCategories[k].name,color:l1c.subCategories[k].color,value:v,percent:v/catTotal*100})).sort((a,b)=>b.value-a.value);const slices=generatePieSlices(data,35,15);const centerText=privacyMode?'***':formatCurrency(convertFromCNY(catTotal,currentDisplayCurrency),currentDisplayCurrency).replace(/[\d,.]+/,m=>m.length>6?(parseFloat(m.replace(/,/g,''))/10000).toFixed(1)+'ä¸‡':m);html+='<div class="mini-chart-card"><div class="mini-chart-title"><div class="mini-chart-title-dot" style="background:'+l1c.color+'"></div>'+l1c.name+'</div><div class="mini-chart-content"><div class="mini-pie-wrapper"><svg class="pie-chart" viewBox="0 0 100 100">'+slices+'</svg><div class="mini-pie-center">'+centerText+'</div></div><div class="mini-legend">'+data.map(item=>'<div class="mini-legend-item"><div class="mini-legend-dot" style="background:'+item.color+'"></div><div class="mini-legend-name">'+item.name+'</div><div class="mini-legend-percent">'+item.percent.toFixed(1)+'%</div></div>').join('')+'</div></div></div>'});grid.innerHTML=html||'<div class="no-data-msg">æš‚æ— åˆ†ç±»æ•°æ®</div>'}

        function renderAssetsList(){const container=document.getElementById('assetsList');const l1t=getLevel1Totals();const total=calculateTotalByCNY();const active=Object.keys(l1t).filter(k=>l1t[k]>0).sort((a,b)=>l1t[b]-l1t[a]);if(active.length===0){container.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">ç‚¹å‡»å³ä¸Šè§’ + æ·»åŠ æ‚¨çš„ç¬¬ä¸€ç¬”èµ„äº§</div></div>';return}let html='';active.forEach(l1=>{const l1c=categoryStructure[l1];const l1Total=l1t[l1];const l1Pct=total>0?(l1Total/total*100).toFixed(1):0;const l1Assets=portfolioData.filter(a=>a.level1===l1);html+='<div class="category-card" id="card-'+l1+'"><div class="category-header" onclick="toggleCard(\''+l1+'\')"><div class="category-color" style="background:'+l1c.color+'"></div><div class="category-info"><div class="category-name">'+l1c.name+'</div><div class="category-count">'+l1Assets.length+' é¡¹</div></div><div class="category-value"><div class="category-amount">'+formatCurrency(convertFromCNY(l1Total,currentDisplayCurrency),currentDisplayCurrency)+'</div><div class="category-percent">'+l1Pct+'%</div></div><div class="category-chevron">â–¼</div></div>';if(l1c.subCategories){Object.keys(l1c.subCategories).forEach(l2=>{const l2c=l1c.subCategories[l2];const l2Assets=l1Assets.filter(a=>a.level2===l2);if(l2Assets.length===0)return;const l2Total=l2Assets.reduce((s,a)=>s+convertToCNY(a.amount,a.currency,false),0);html+='<div class="sub-category" id="subcat-'+l1+'-'+l2+'"><div class="sub-category-header" onclick="toggleSubCategory(\''+l1+'\',\''+l2+'\')"><div class="sub-category-dot" style="background:'+l2c.color+'"></div><div class="sub-category-name">'+l2c.name+'</div><div class="sub-category-value">'+formatCurrency(convertFromCNY(l2Total,currentDisplayCurrency),currentDisplayCurrency)+'</div><div class="sub-category-chevron">â–¼</div></div><div class="sub-items">'+l2Assets.map(a=>renderAssetItem(a)).join('')+'</div></div>'})}else{html+='<div class="sub-category expanded" id="subcat-'+l1+'"><div class="sub-items" style="display:block">'+l1Assets.map(a=>renderAssetItem(a)).join('')+'</div></div>'}html+='<div class="add-sub-btn" onclick="openAddModalWithCategory(\''+l1+'\')">+ æ·»åŠ '+l1c.name+'</div></div>'});container.innerHTML=html}

        function renderAssetItem(asset){const isGold=asset.level1==='gold';const cny=convertToCNY(asset.amount,asset.currency,isGold);const disp=convertFromCNY(cny,currentDisplayCurrency);let detail=asset.note||'';if(isGold){detail=(privacyMode?'***':asset.amount+'å…‹')+' '+detail}else if(asset.currency!=='CNY'){detail+=' (åŸå¸: '+formatCurrency(asset.amount,asset.currency)+')'}return '<div class="sub-item"><div class="sub-item-info"><div class="sub-item-name">'+asset.name+'</div><div class="sub-item-detail">'+detail+'</div></div><div class="sub-item-value">'+formatCurrency(disp,currentDisplayCurrency)+'</div><div class="sub-item-actions"><button class="action-btn" onclick="editAsset(\''+asset.id+'\')">âœ</button><button class="action-btn delete" onclick="deleteAsset(\''+asset.id+'\')">âœ•</button></div></div>'}

        function toggleCard(l1){document.getElementById('card-'+l1).classList.toggle('expanded')}
        function toggleSubCategory(l1,l2){document.getElementById('subcat-'+l1+'-'+l2).classList.toggle('expanded')}

        document.querySelectorAll('.currency-btn').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.currency-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');currentDisplayCurrency=btn.dataset.currency;render()})});
        document.querySelectorAll('.chart-tab').forEach(tab=>{tab.addEventListener('click',()=>{document.querySelectorAll('.chart-tab').forEach(t=>t.classList.remove('active'));tab.classList.add('active');currentChartView=tab.dataset.level;document.getElementById('overviewChart').classList.toggle('active',currentChartView==='overview');document.getElementById('ratioChart').classList.toggle('active',currentChartView==='ratio');document.getElementById('breakdownChart').classList.toggle('active',currentChartView==='breakdown')})});

        function openAddModal(){document.getElementById('addModal').classList.add('active');document.getElementById('addForm').reset();document.getElementById('assetLevel1').value='fixed_deposit';updateLevel2Options()}
        function openAddModalWithCategory(l1){openAddModal();document.getElementById('assetLevel1').value=l1;updateLevel2Options()}
        function closeAddModal(){document.getElementById('addModal').classList.remove('active')}

        function updateLevel2Options(){const l1=document.getElementById('assetLevel1').value;const l1c=categoryStructure[l1];const l2g=document.getElementById('level2Group');const l2s=document.getElementById('assetLevel2');if(l1c.subCategories){l2g.classList.remove('hidden');l2s.innerHTML=Object.entries(l1c.subCategories).map(([k,c])=>'<option value="'+k+'">'+c.name+'</option>').join('')}else{l2g.classList.add('hidden')}updateFormFields()}

        function updateFormFields(){const l1=document.getElementById('assetLevel1').value;const l1c=categoryStructure[l1];const l2=document.getElementById('assetLevel2').value;const bankG=document.getElementById('bankGroup');const nameG=document.getElementById('nameGroup');const currG=document.getElementById('currencyGroup');const amtL=document.getElementById('amountLabel');const nameL=document.getElementById('nameLabel');let isBank=false,isGold=l1c.isGold,defCur='CNY';if(l1c.subCategories&&l2){const l2c=l1c.subCategories[l2];isBank=l2c.isBank;defCur=l2c.defaultCurrency}if(isBank){bankG.classList.remove('hidden');nameG.classList.add('hidden')}else{bankG.classList.add('hidden');nameG.classList.remove('hidden');nameL.textContent=isGold?'é»„é‡‘äº§å“åç§°':'åç§°'}if(isGold){currG.classList.add('hidden');amtL.textContent='å…‹æ•°'}else{currG.classList.remove('hidden');amtL.textContent='é‡‘é¢';document.getElementById('assetCurrency').value=defCur}}

        function handleAddAsset(e){e.preventDefault();const l1=document.getElementById('assetLevel1').value;const l1c=categoryStructure[l1];const l2=l1c.subCategories?document.getElementById('assetLevel2').value:null;let name;let isBank=false;if(l1c.subCategories&&l2){isBank=l1c.subCategories[l2].isBank}name=isBank?document.getElementById('assetBank').value:document.getElementById('assetName').value;const asset={id:Date.now().toString(),level1:l1,level2:l2,name:name,amount:parseFloat(document.getElementById('assetAmount').value),currency:l1c.isGold?'GOLD':document.getElementById('assetCurrency').value,note:document.getElementById('assetNote').value};portfolioData.push(asset);saveData();render();closeAddModal()}

        function editAsset(id){const asset=portfolioData.find(a=>a.id===id);if(!asset)return;const isGold=asset.level1==='gold';document.getElementById('editAssetId').value=id;document.getElementById('editAssetName').value=asset.name;document.getElementById('editAssetAmount').value=asset.amount;document.getElementById('editAssetNote').value=asset.note||'';if(isGold){document.getElementById('editCurrencyGroup').classList.add('hidden');document.getElementById('editAmountLabel').textContent='å…‹æ•°'}else{document.getElementById('editCurrencyGroup').classList.remove('hidden');document.getElementById('editAmountLabel').textContent='é‡‘é¢';document.getElementById('editAssetCurrency').value=asset.currency}document.getElementById('editModal').classList.add('active')}
        function closeEditModal(){document.getElementById('editModal').classList.remove('active')}
        function handleEditAsset(e){e.preventDefault();const id=document.getElementById('editAssetId').value;const asset=portfolioData.find(a=>a.id===id);if(!asset)return;asset.name=document.getElementById('editAssetName').value;asset.amount=parseFloat(document.getElementById('editAssetAmount').value);if(asset.level1!=='gold'){asset.currency=document.getElementById('editAssetCurrency').value}asset.note=document.getElementById('editAssetNote').value;saveData();render();closeEditModal()}
        function deleteAsset(id){if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ'))return;portfolioData=portfolioData.filter(a=>a.id!==id);saveData();render()}

        function openSettingsModal(){document.getElementById('settingUsdCny').value=settings.usdCny;document.getElementById('settingHkdCny').value=settings.hkdCny;document.getElementById('settingJpyCny').value=settings.jpyCny;document.getElementById('settingGold').value=settings.goldPrice;document.getElementById('settingsModal').classList.add('active')}
        function closeSettingsModal(){document.getElementById('settingsModal').classList.remove('active')}
        function handleSaveSettings(e){e.preventDefault();settings.usdCny=parseFloat(document.getElementById('settingUsdCny').value);settings.hkdCny=parseFloat(document.getElementById('settingHkdCny').value);settings.jpyCny=parseFloat(document.getElementById('settingJpyCny').value);settings.goldPrice=parseFloat(document.getElementById('settingGold').value);saveData();updateRateBanner();render();closeSettingsModal()}
        function clearAllData(){if(!confirm('ç¡®å®šæ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Ÿ'))return;portfolioData=[];saveData();render();closeSettingsModal()}

        function exportData(){const exportObj={version:7,exportDate:new Date().toISOString(),settings:settings,assets:portfolioData};const dataStr=JSON.stringify(exportObj,null,2);const blob=new Blob([dataStr],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='portfolio_backup_'+new Date().toISOString().slice(0,10)+'.json';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url)}

        function importData(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(evt){try{const imported=JSON.parse(evt.target.result);if(imported.assets){portfolioData=imported.assets}if(imported.settings){settings={...settings,...imported.settings}}saveData();updateRateBanner();render();alert('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ '+portfolioData.length+' æ¡è®°å½•');closeSettingsModal()}catch(err){alert('âŒ å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®')}};reader.readAsText(file);e.target.value=''}

        document.querySelectorAll('.modal-overlay').forEach(o=>{o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active')})});

        loadData();render();
    </script>
</body>
</html>
